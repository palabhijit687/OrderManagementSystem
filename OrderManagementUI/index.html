<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Form</title>
</head>
<body>
  <h1>Order Form</h1>

  <form id="orderForm">
    <div>
      <label for="userIdSelect">User:</label>
      <select id="userIdSelect" name="userId"></select>
    </div>

    <div>
      <label for="itemSelect">Item:</label>
      <select id="itemSelect"></select>
      <label for="quantityInput">Quantity:</label>
      <input type="number" id="quantityInput" name="quantity" min="1" value="1">
      <button type="button" onclick="addItem()">Add Item</button>
    </div>

    <table id="orderItemsTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="orderItemsTableBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="2"></td>
          <td id="totalAmountCell"></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div>
      <button type="submit">Submit Order</button>
    </div>
  </form>

  <script>
    // Fetch users data using AJAX
    fetch('/api/users')
      .then(response => response.json())
      .then(data => {
        const userIdSelect = document.getElementById('userIdSelect');
        data.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.name;
          userIdSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Failed to fetch users:', error);
      });

    // Fetch items data using AJAX
    fetch('/api/items')
      .then(response => response.json())
      .then(data => {
        const itemSelect = document.getElementById('itemSelect');
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item.item_id;
          option.textContent = item.item_name;
          itemSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Failed to fetch items:', error);
      });

    // Function to calculate the total amount
    function calculateTotalAmount() {
      const table = document.getElementById('orderItemsTable');
      const rows = table.rows;
      let totalAmount = 0;

      for (let i = 1; i < rows.length - 1; i++) {
        const quantityCell = rows[i].cells[1];
        const amountCell = rows[i].cells[2];
        const quantity = parseInt(quantityCell.textContent, 10);
        const price = parseFloat(amountCell.dataset.price);
        const amount = quantity * price;
        amountCell.textContent = amount.toFixed(2);
        totalAmount += amount;
      }

      const totalAmountCell = document.getElementById('totalAmountCell');
      totalAmountCell.textContent = totalAmount.toFixed(2);
    }

    // Function to add an item to the order
    function addItem() {
      const itemSelect = document.getElementById('itemSelect');
      const quantityInput = document.getElementById('quantityInput');
      const selectedOption = itemSelect.options[itemSelect.selectedIndex];
      const itemName = selectedOption.textContent;
      const itemId = selectedOption.value;
      const quantity = parseInt(quantityInput.value, 10);

      const tableBody = document.getElementById('orderItemsTableBody');
      const newRow = tableBody.insertRow();
      const itemCell = newRow.insertCell();
      const quantityCell = newRow.insertCell();
      const amountCell = newRow.insertCell();
      const deleteCell = newRow.insertCell();

      itemCell.textContent = itemName;
      quantityCell.textContent = quantity;
      amountCell.dataset.price = selectedOption.dataset.price;
      deleteCell.innerHTML = '<button type="button" onclick="deleteItem(this)">Delete</button>';

      calculateTotalAmount();
    }

    // Function to delete an item from the order
    function deleteItem(button) {
      const row = button.parentNode.parentNode;
      row.parentNode.removeChild(row);
      calculateTotalAmount();
    }

    // Submit order form using AJAX
    const orderForm = document.getElementById('orderForm');
    orderForm.addEventListener('submit', function(event) {
      event.preventDefault();

      // Retrieve form data
      const formData = new FormData(orderForm);
      const order = {};

      for (const [name, value] of formData) {
        order[name] = value;
      }

      // Retrieve order items
      const table = document.getElementById('orderItemsTable');
      const rows = table.rows;
      const orderItems = [];

      for (let i = 1; i < rows.length - 1; i++) {
        const itemCell = rows[i].cells[0];
        const quantityCell = rows[i].cells[1];
        const item = {
          itemId: itemCell.dataset.itemId,
          quantity: parseInt(quantityCell.textContent, 10)
        };
        orderItems.push(item);
      }

      order.orderItems = orderItems;

      // Send order data to the server using AJAX
      fetch('/api/saveOrder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(order)
      })
        .then(response => response.json())
        .then(data => {
          console.log('Order saved:', data);
          // Handle success or display appropriate message
        })
        .catch(error => {
          console.error('Failed to save order:', error);
          // Handle error or display appropriate message
        });
    });
  </script>
</body>
</html>
